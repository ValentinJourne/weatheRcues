---
title: "Get started"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Get started}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE,
                      comment  = "#>")
```


```{r setup}
library(mgcv)
library(weatheRcues)

```

Here I simulated some climate and seed production (because we all love seed production and want to know more about plant mast seeding). If you are studying small mammals, please study mast seeding :D 
```{r generatedata, echo=FALSE, results='hide'}
library(tidyverse)
set.seed(123)  
startyear = 1940
years <- startyear:2020
days_per_year <- 365
climate_data_simulated <- data.frame(
  date = seq.Date(from = as.Date(paste0(startyear,"-01-01")), by = "day", length.out = length(years) * days_per_year),
  temp = runif(length(years) * days_per_year, min = 10, max = 30) 
)

climate_data_simulated <- climate_data_simulated %>%
  mutate(year = format(date, "%Y"),
         yday = yday(date),
         year = as.numeric(year)) %>%
  mutate(across(c(temp), scale)) %>%
  mutate(across(c(temp), as.vector)) %>% 
  mutate(LONGITUDE = NA, LATITUDE = NA)

# Select ~ one week in June 
june_week <- climate_data_simulated %>%
  filter(yday >= 150 & yday <= 160)

seed_production_simulated <- june_week %>%
  group_by(year) %>%
  summarise(mean_temp_june_week = mean(temp)) %>%
  # Standardize the mean temperature for proper correlation, as in the main analysis
  mutate(mean_temp_scaled = scale(mean_temp_june_week, center = TRUE, scale = TRUE)) %>%
  # Generate log.seed with controlled correlation
  mutate(log.seed = 1 + 5 * mean_temp_scaled + rnorm(n(), mean = 0, sd = 1))%>%
  filter(year > startyear)%>% #to select one year less 
  mutate(year = as.numeric(as.character(year))) %>% 
  mutate(Date = paste0( "15/06/",year)) %>% #need a date, even if absolute window
  mutate(Date2 = strptime(as.character(Date), format = "%d/%m/%Y"))  %>%
  dplyr::mutate(across(c(mean_temp_scaled, log.seed), as.vector)) %>% 
  mutate(plotname.lon.lat = "test",
         sitenewname = "test")#remove the vector type 
  

```

For the first method, I was using climwin R package. Here I customize a bit the function, but you can specify more option (for aggregate weather window for example).
```{r slidingwindow}
head(seed_production_simulated)
head(climate_data_simulated)

climwin.output = runing_climwin(
        climate_data = climate_data_simulated,
        bio_data = seed_production_simulated,
        site.name = 'test',
        range = c(10, 0), #double check if climate is long enough (to match bio data)
        cinterval = 'day',
        refday = c(01, 11),
        optionwindows = 'absolute',
        climate_var = 'temp'
      )

climwin.output

```

The others method, the idea is to make a correalation for each days with your variable of interest. 


```{r PSR}
head(seed_production_simulated)
head(climate_data_simulated)

pspline.output = runing_psr(
  bio_data = seed_production_simulated,
  site = 'test',
  climate_data = climate_data_simulated,
  lastdays = 10,
  refday = 305,
  rollwin = 1,
  formula_model = formula('log.seed ~ temp'),
  matrice = c(3, 1),
  knots = NULL,
  tolerancedays = 7,
  yearneed = 1
)

pspline.output
```


```{r CSP and Peak}
head(seed_production_simulated)
head(climate_data_simulated)

daily.relation.res = runing_daily_relationship(
  bio_data = seed_production_simulated,
  climate_data = climate_data_simulated,
  lastdays = 50,
  refday = 305,
  rollwin = 1,
  formula_model = formula('log.seed ~ temp'),
  yearneed = 1
)

csp.out = runing_csp(Results_days =daily.relation.res,
           bio_data = seed_production_simulated,
           climate_data= climate_data_simulated,
           siteneame.forsub = "test",
           refday = 305,
           lastdays = 50,
           rollwin = 1, yearneed = 1,
           k.provided = -1, #by default please keep na, here is just a test to make it fast
           formula_model = formula('log.seed ~ temp'), optim.k = F, option.check.name = F)
csp.out
peak.out = runing_peak_detection(Results_days = daily.relation.res,
           bio_data = seed_production_simulated,
           climate_data = climate_data_simulated,
           refday = 305,
           lastdays = 50,
           rollwin = 1, yearneed = 1,formula_model = formula('log.seed ~ temp'),
           lag = 10,
           threshold = 0,
  tolerancedays = 7)
peak.out
```
